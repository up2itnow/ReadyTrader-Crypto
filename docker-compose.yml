# ReadyTrader-Crypto Production Stack
# 
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose logs -f            # View logs
#   docker-compose down               # Stop all services
#
# Services:
#   - api: FastAPI server with WebSocket support
#   - mcp: MCP server for agent integration
#   - frontend: Next.js dashboard (optional)
#   - redis: Caching layer (optional)
#
# Configuration:
#   Copy .env.example to .env and configure before starting

version: '3.8'

services:
  # ===========================================================================
  # Core API Server
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: readytrader-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Mode settings
      - PAPER_MODE=${PAPER_MODE:-true}
      - LIVE_TRADING_ENABLED=${LIVE_TRADING_ENABLED:-false}
      - TRADING_HALTED=${TRADING_HALTED:-false}
      - DEV_MODE=${DEV_MODE:-false}
      
      # API settings
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_AUTH_REQUIRED=${API_AUTH_REQUIRED:-false}
      - API_JWT_SECRET=${API_JWT_SECRET}
      - API_ADMIN_USERNAME=${API_ADMIN_USERNAME:-admin}
      - API_ADMIN_PASSWORD_HASH=${API_ADMIN_PASSWORD_HASH}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      
      # Execution settings
      - EXECUTION_MODE=${EXECUTION_MODE:-hybrid}
      - EXECUTION_APPROVAL_MODE=${EXECUTION_APPROVAL_MODE:-auto}
      - RISK_PROFILE=${RISK_PROFILE:-conservative}
      
      # Signer (live mode only)
      - SIGNER_TYPE=${SIGNER_TYPE:-env_private_key}
      - PRIVATE_KEY=${PRIVATE_KEY}
      - SIGNER_REMOTE_URL=${SIGNER_REMOTE_URL}
      
      # Policy limits
      - ALLOW_CHAINS=${ALLOW_CHAINS}
      - ALLOW_TOKENS=${ALLOW_TOKENS}
      - ALLOW_EXCHANGES=${ALLOW_EXCHANGES}
      - MAX_TRADE_AMOUNT=${MAX_TRADE_AMOUNT}
      - MAX_CEX_ORDER_AMOUNT=${MAX_CEX_ORDER_AMOUNT}
      
      # CEX credentials
      - CEX_API_KEY=${CEX_API_KEY}
      - CEX_API_SECRET=${CEX_API_SECRET}
      - CEX_BINANCE_API_KEY=${CEX_BINANCE_API_KEY}
      - CEX_BINANCE_API_SECRET=${CEX_BINANCE_API_SECRET}
      
      # Market data
      - MARKETDATA_EXCHANGES=${MARKETDATA_EXCHANGES:-binance,kraken,coinbase}
      
      # Persistence
      - AUDIT_DB_PATH=/app/data/audit.db
      - IDEMPOTENCY_DB_PATH=/app/data/idempotency.db
      - EXECUTION_DB_PATH=/app/data/execution.db
      - PAPER_DB_PATH=/app/data/paper.db
      
      # Redis (optional)
      - REDIS_URL=${REDIS_URL:-}
      
      # Observability
      - READYTRADER_LOG_LEVEL=${READYTRADER_LOG_LEVEL:-info}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    volumes:
      - readytrader-data:/app/data
    command: ["python", "-m", "uvicorn", "api_server:app", "--host", "0.0.0.0", "--port", "8000"]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - readytrader-net
    depends_on:
      redis:
        condition: service_healthy
        required: false

  # ===========================================================================
  # MCP Server (for agent integration)
  # ===========================================================================
  mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: readytrader-mcp
    restart: unless-stopped
    stdin_open: true
    tty: true
    environment:
      - PAPER_MODE=${PAPER_MODE:-true}
      - LIVE_TRADING_ENABLED=${LIVE_TRADING_ENABLED:-false}
      - TRADING_HALTED=${TRADING_HALTED:-false}
      - DEV_MODE=${DEV_MODE:-false}
      - EXECUTION_MODE=${EXECUTION_MODE:-hybrid}
      - EXECUTION_APPROVAL_MODE=${EXECUTION_APPROVAL_MODE:-auto}
      - RISK_PROFILE=${RISK_PROFILE:-conservative}
      - SIGNER_TYPE=${SIGNER_TYPE:-env_private_key}
      - PRIVATE_KEY=${PRIVATE_KEY}
      - ALLOW_CHAINS=${ALLOW_CHAINS}
      - ALLOW_TOKENS=${ALLOW_TOKENS}
      - MAX_TRADE_AMOUNT=${MAX_TRADE_AMOUNT}
      - CEX_API_KEY=${CEX_API_KEY}
      - CEX_API_SECRET=${CEX_API_SECRET}
      - MARKETDATA_EXCHANGES=${MARKETDATA_EXCHANGES:-binance,kraken,coinbase}
      - AUDIT_DB_PATH=/app/data/audit.db
      - PAPER_DB_PATH=/app/data/paper.db
    volumes:
      - readytrader-data:/app/data
    command: ["python", "app/main.py"]
    networks:
      - readytrader-net

  # ===========================================================================
  # Frontend Dashboard (Optional)
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: readytrader-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:${API_PORT:-8000}
      - NEXT_PUBLIC_WS_URL=ws://localhost:${API_PORT:-8000}/ws
    depends_on:
      - api
    networks:
      - readytrader-net
    profiles:
      - with-frontend

  # ===========================================================================
  # Redis Cache (Optional)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: readytrader-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - readytrader-net
    profiles:
      - with-redis

  # ===========================================================================
  # PostgreSQL (Optional - for multi-instance deployments)
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: readytrader-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=readytrader
      - POSTGRES_USER=${POSTGRES_USER:-readytrader}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-readytrader}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - readytrader-net
    profiles:
      - with-postgres

volumes:
  readytrader-data:
    driver: local
  redis-data:
    driver: local
  postgres-data:
    driver: local

networks:
  readytrader-net:
    driver: bridge
